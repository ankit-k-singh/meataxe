upstream puma {
    # fail_timeout=0 means we always retry an upstream even if it failed to return
    # a good HTTP response (in case the Puma master nukes a single worker for timing out).
    server unix:///home/deploy/anionu/shared/sockets/puma.sock fail_timeout=0;
}

server {
    listen                80;
    server_name           <%= server_name %>;    
    root                  <%= current_path %>/public;

    # location ~ "^/assetpipe/(.*/)*.*-[0-9a-f]{32}.*"
    location ^~ /<%= assets_prefix %>/ {
        # gzip_static on; # gzip seems to be working without this
        expires max;
        access_log off;
        add_header Cache-Control public;
    }

    try_files $uri/index.html $uri @puma;
    location @puma {
        proxy_pass         http://puma;    
        proxy_redirect     off;

        proxy_set_header   Host             $host;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;

        proxy_set_header   X-Sendfile-Type  X-Accel-Redirect;
        proxy_set_header   X-Accel-Mapping  <%= shared_path %>/storage/=<%= shared_path %>/storage/; 
    }

    # Redirect server error pages to the static page /50x.html
    error_page 500 502 503 504 /50x.html;
    
    client_max_body_size 100m;
    keepalive_timeout 10;
    
    access_log            <%= shared_path %>/log/nginx_access.log;
    error_log             <%= shared_path %>/log/nginx_error.log;
}